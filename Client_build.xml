<project name="LucteriosClient" default="build" basedir=".">
	
	<property name="projet.sources.dir" value="${ant.project.name}/org"/>
	<property name="projet.src.dir" value="src_client"/>
	<property name="projet.bin.dir" value="${ant.project.name}"/>
	<property name="projet.doc.dir" value="${ant.project.name}/doc"/>
	<property name="projet.lib.dir" value="lib"/>
	<property name="build.instrumented.dir" value="${ant.project.name}/instrumented-classes" />


	<path id="cobertura.classpath">
		<fileset dir="lib">
			<include name="cobertura.jar" />
			<include name="**/*.jar" />
		</fileset>
	</path>
	<taskdef classpathref="cobertura.classpath" resource="tasks.properties"/>

	<path id="projet.classpath">
		<pathelement location="${projet.bin.dir}" />
	</path>

	<target name="instrument">
		<delete dir="${projet.src.dir}/org/lucterios/style" /> 
		<delete dir="${projet.src.dir}/org/lucterios/swing" /> 
		<mkdir dir="${build.instrumented.dir}" /> 		
		<cobertura-instrument todir="${build.instrumented.dir}">
		    <fileset dir="${projet.src.dir}/org/lucterios">
			<include name="**/*.class"/>
			<exclude name="**/*Unit.class" />
			<exclude name="**/*Tests.class" />
		    </fileset>
		</cobertura-instrument>
	</target>

	<target name="junit">
		<delete dir=".LucteriosCache" />
		<mkdir dir=".LucteriosCache" /> 		
		<junit fork="yes" printsummary="no" haltonfailure="no">
			<classpath location="${build.instrumented.dir}"/>
			<classpath location="${projet.src.dir}" />
			<classpath refid="cobertura.classpath" />

			<jvmarg value="-Djava.awt.headless=true"/>
			<batchtest fork="yes" todir="${projet.bin.dir}" >
				<fileset dir="${projet.src.dir}">
					<include name="**/AllTests.class" />
				</fileset>
			</batchtest>
			<formatter type="xml" />
	      </junit>
	</target>

	<target name="coverage-report">
	      <cobertura-report srcdir="${projet.src.dir}" destdir="${ant.project.name}/cobertura-xml" format="xml" />
	      <cobertura-report destdir="${ant.project.name}/cobertura-html">
		      <fileset dir="${projet.src.dir}">
			      <include name="**/*.java"/>
			</fileset>
	      </cobertura-report>
	</target>


	<target name="tests" depends="instrument,junit,coverage-report" />

	<target name="build" depends="clear,compile,packaging" />
	
	<target name="clear">
		<delete dir="${projet.src.dir}" /> 
		<mkdir dir="${projet.src.dir}" /> 		
		<delete dir="${projet.doc.dir}" /> 
		<delete file="${projet.src.dir}/${ant.project.name}.jar" /> 
		<delete>
			<fileset dir="${ant.project.name}" includes="TEST*.xml" />
		</delete>
		<delete>		  
			<fileset dir="${projet.src.dir}" includes="**/*.class" />
			<fileset dir="${projet.sources.dir}" includes="**/*.class" />
			<fileset dir="LucteriosUtils/org" includes="**/*.class" />
			<fileset dir="LucteriosSwing/org" includes="**/*.class" />
			<fileset dir="LucteriosPrint/org" includes="**/*.class" />
			<fileset dir="LucteriosEngine/org" includes="**/*.class" />
			<fileset dir="LucteriosClient/org" includes="**/*.class" />
		</delete>
		<delete file="cobertura.ser"/>
		<delete dir="${build.instrumented.dir}" />
		<delete dir="${ant.project.name}/cobertura-xml" />
		<delete dir="${ant.project.name}/cobertura-html" />
	</target>

	<target name="init">
		<unzip src="${projet.lib.dir}/commons-codec-1.3.jar" dest="${projet.src.dir}" />
		<unzip src="${projet.lib.dir}/commons-httpclient-3.1.jar" dest="${projet.src.dir}" />
		<unzip src="${projet.lib.dir}/commons-logging-1.0.4.jar" dest="${projet.src.dir}" />
		<unzip src="${projet.lib.dir}/contrib.jar" dest="${projet.src.dir}" />
		<unzip src="${projet.lib.dir}/js.jar" dest="${projet.src.dir}" />
		<unzip src="${projet.lib.dir}/junit.jar" dest="${projet.src.dir}" />
		<unzip src="${projet.lib.dir}/PgsLookAndFeel.jar" dest="${projet.src.dir}" />
		<delete dir="${projet.src.dir}/junit3.8.1" /> 
		<delete dir="${projet.src.dir}/META-INF" /> 
		<delete file="${projet.src.dir}/Manifest.txt" /> 
		<delete file="${projet.src.dir}/stylesheet.css" /> 
		<mkdir dir="${projet.src.dir}/org" /> 		
		<copy todir="${projet.src.dir}/org">
		    <fileset dir="LucteriosUtils/org"/>
		    <fileset dir="LucteriosSwing/org"/>
		    <fileset dir="LucteriosPrint/org"/>
		    <fileset dir="LucteriosEngine/org"/>
		    <fileset dir="LucteriosClient/org"/>
		</copy>
	</target>

	<target name="compile" depends="init" description="Compilation des classes">
		<javac srcdir="${projet.src.dir}"
			destdir="${projet.src.dir}"
			encoding="utf-8"
			target="1.6"
			source="1.6"
			debug="true" 
			debuglevel="vars,lines,source"
			optimize="on" 
			includeAntRuntime="false"
			deprecation="off">
			<classpath refid="projet.classpath"/>
		</javac>
	</target>
	
	<target name="packaging">
		<manifest file="${projet.bin.dir}/Manifest.txt">
			<attribute name="Created-By" value="Lucterios"/>
			<attribute name="Main-Class" value="org.lucterios.client.Main"/>
			<attribute name="Class-Path" value="." />
			<section name="LucteriosClient">
				<attribute name="Specification-Title" value="LucteriosClient"/>
				<attribute name="Specification-Version" value="${projet.version.max}.${projet.version.min}"/>
				<attribute name="Specification-Vendor" value="lucterios.org"/>
				<attribute name="Implementation-Title" value="LucteriosClient"/>
				<attribute name="Implementation-Version" value="${projet.version.max}.${projet.version.min}.${projet.version.release}.${projet.version.build} ${TODAY}"/> 
				<attribute name="Implementation-Vendor" value="lucterios.org"/>
			</section>
		</manifest>		
		<jar jarfile="${projet.bin.dir}/${ant.project.name}.jar" basedir="${projet.src.dir}" manifest="${projet.bin.dir}/Manifest.txt"  excludes='.svn'/>
		<copy file="${projet.bin.dir}/${ant.project.name}.jar" todir="." overwrite="true"/>
	</target>
	
	<target name="javadoc">
		<delete dir="${projet.doc.dir}" /> 
		<mkdir dir="${projet.doc.dir}" /> 
		<javadoc sourcepath="${projet.src.dir}" destdir="${projet.doc.dir}" >
			<fileset dir="${projet.src.dir}" defaultexcludes="yes">
				<include name="**/*.java" />				
			</fileset>
		</javadoc>
	</target> 
		
</project>